# === Canonical redirect: tofulbagel.moo.jp -> https://tofulbagel.com/ ===
RewriteEngine On

# Let's Encrypt の検証はリダイレクトしない
RewriteCond %{REQUEST_URI} ^/.well-known/acme-challenge/ [NC]
RewriteRule ^ - [L]

# 新ドメイン以外は https://tofulbagel.com/ へ 301（パス/クエリ維持）
RewriteCond %{HTTP_HOST} !^tofulbagel\.com$ [NC]
RewriteRule ^(.*)$ https://tofulbagel.com/$1 [R=301,L]


# 新ドメインで http なら https に 301
RewriteCond %{HTTPS} off
RewriteCond %{HTTP_HOST} ^tofulbagel\.com$ [NC]
RewriteRule ^(.*)$ https://tofulbagel.com/$1 [R=301,L]

# ===== 画像は圧縮しない（gzip / brotli）=====
<IfModule mod_deflate.c>
  SetEnvIfNoCase Request_URI "\.(?:gif|jpe?g|png|webp|ico|bmp|svg|mp4|webm)$" no-gzip dont-vary
</IfModule>
<IfModule mod_brotli.c>
  SetEnvIfNoCase Request_URI "\.(?:gif|jpe?g|png|webp|ico|bmp|svg|mp4|webm)$" no-brotli
</IfModule>

# ===== WebP 自動配信 =====
# ループ回避：既に .webp を要求しているときは何もしない
RewriteCond %{REQUEST_URI} !\.webp$ [NC]
# ブラウザが WebP を受け入れる
RewriteCond %{HTTP_ACCEPT} image/webp
# 同名.webp が存在する
RewriteCond %{REQUEST_FILENAME}\.webp -f
# jpg/png → 同名の「.jpg.webp / .png.webp」に内部リライト
# （もし保存名が foo.webp なら、下の行を `$1.webp` に変えて、1行上も `%{REQUEST_FILENAME}.webp` にする）
RewriteRule (.+)\.(jpe?g|png)$ $1.$2.webp [T=image/webp,E=accept:1,L]

# .webp の MIME を明示（静的 .webp 直配信用）
AddType image/webp .webp

# Vary: Accept を確実に付与（キャッシュ混在防止）
<IfModule mod_headers.c>
  Header merge Vary Accept
</IfModule>

# --- セキュリティ強化ヘッダー ---
<IfModule mod_headers.c>
  Header always set X-Content-Type-Options "nosniff"
  Header always set Referrer-Policy "strict-origin-when-cross-origin"
  Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
  Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
</IfModule>

# --- 不要ファイルへの直接アクセスを防止 ---
<FilesMatch "\.(htaccess|htpasswd|env|ini|log|sh|bak|sql)$">
  Require all denied
</FilesMatch>

# --- エラーページ設定 ---
ErrorDocument 403 /index.php
ErrorDocument 404 /index.php
